const _ = require('lodash');

function getCompanies(page) {
  return new Promise((res, rej) => {
    var exec = require('child_process').exec;

    var command = `curl 'https://angel.co/graphql?fallbackAOR=talent' -H 'User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:86.0) Gecko/20100101 Firefox/86.0' -H 'Accept: */*' -H 'Accept-Language: en-US,en;q=0.5' --compressed -H 'Referer: https://angel.co/jobs' -H 'content-type: application/json' -H 'X-Requested-With: XMLHttpRequest' -H 'X-AL-GQL: 3wxpnT2tC50tUrobF69XKN3HUnypl%2BavsL1HpGXfsjA%3D' -H 'Origin: https://angel.co' -H 'Connection: keep-alive' -H 'Cookie: _ga=GA1.2.164903625.1586620695; ajs_anonymous_id=%22ede04b5ad84c1bd4d66a02b4bc12e7c9%22; _hjid=bc7745a5-75cb-4044-9d48-64aef60f5f5d; __cfduid=deed34ab60d0d6f57f0b344cdfcc034381615463732; _angellist=df0ab478229eef31f89864e05804b984; _gid=GA1.2.957331268.1615463735; _dd_s=rum=1&id=d95f1969-be68-485d-9b52-f6fcf9b91445&created=1615463735543&expire=1615464715866; datadome=K.O.NntjSB2CDyU0Bktfo3_GqFJbekQryOe.CpbE_l6Jc.eEeUCUgd5LQWQjZTRqYJT~TG~FU47W7Wq~ZPV~xI5q~XTKEEC2arVFvdD.hx; _hjIncludedInSessionSample=1; _hjAbsoluteSessionInProgress=1; logged_in=true; ajs_user_id=%228747011%22; _gat=1' -H 'TE: Trailers' --data-raw '{"operationName":"JobSearchResultsX","variables":{"filterConfigurationInput":{"page":${page},"equity":{"min":null,"max":null},"remotePreference":"NO_REMOTE","salary":{"min":null,"max":null},"yearsExperience":{"min":null,"max":null}}},"query":"query JobSearchResultsX($filterConfigurationInput: FilterConfigurationInput!) {\n  talent {\n    jobSearchResults(filterConfigurationInput: $filterConfigurationInput) {\n      rawQuery\n      totalStartupCount\n      startups {\n        edges {\n          node {\n            ... on StartupSearchResult {\n              ...StartupResultSearchResultFragment\n              __typename\n            }\n            ... on PromotedResult {\n              ...PromotedResultFragment\n              __typename\n            }\n            ... on FeaturedStartups {\n              id\n              featuredStartups {\n                ...PromotedResultFragment\n                __typename\n              }\n              __typename\n            }\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n}\n\nfragment StartupResultSearchResultFragment on StartupSearchResult {\n  id\n  ...BadgeBarSearchResultFragment\n  ...StartupHeaderSearchResultFragment\n  ...StartupInsightNewsSearchResultFragment\n  ...StarStartupSearchResultButtonFragment\n  highlightedJobListings {\n    ...JobListingListSearchResultFragment\n    __typename\n  }\n  __typename\n}\n\nfragment BadgeBarSearchResultFragment on StartupSearchResult {\n  id\n  badges {\n    ...BadgeFragment\n    __typename\n  }\n  __typename\n}\n\nfragment BadgeFragment on Badge {\n  id\n  name\n  label\n  tooltip\n  avatarUrl\n  rating\n  __typename\n}\n\nfragment StartupHeaderSearchResultFragment on StartupSearchResult {\n  id\n  name\n  slug\n  logoUrl\n  highConcept\n  companySize\n  locationTaggings {\n    id\n    displayName\n    __typename\n  }\n  __typename\n}\n\nfragment StartupInsightNewsSearchResultFragment on StartupSearchResult {\n  id\n  newsStoryUrl\n  newsStoryHeadline\n  newsStorySnippet\n  newsStoryThumbnailUrl\n  newsStoryPublishedDate\n  newsStorySource\n  __typename\n}\n\nfragment StarStartupSearchResultButtonFragment on StartupSearchResult {\n  id\n  currentUserHasStarred\n  __typename\n}\n\nfragment JobListingListSearchResultFragment on JobListingSearchResult {\n  id\n  autoPosted\n  atsSource\n  description\n  jobType\n  liveStartAt\n  locationNames\n  primaryRoleTitle\n  remote\n  slug\n  title\n  reposted\n  ...JobListingCompensationSearchResultFragment\n  __typename\n}\n\nfragment JobListingCompensationSearchResultFragment on JobListingSearchResult {\n  id\n  compensation\n  estimatedSalary\n  equity\n  usesEstimatedSalary\n  __typename\n}\n\nfragment StartupResultFragment on Startup {\n  id\n  startupId\n  ...BadgeBarFragment\n  ...StartupHeaderFragment\n  ...StartupInsightNewsFragment\n  ...StarStartupButtonFragment\n  highlightedJobListings {\n    ...JobListingListFragment\n    __typename\n  }\n  __typename\n}\n\nfragment BadgeBarFragment on Startup {\n  id\n  badges {\n    ...BadgeFragment\n    __typename\n  }\n  __typename\n}\n\nfragment StartupHeaderFragment on Startup {\n  id\n  name\n  slug\n  logoUrl\n  highConcept\n  companySize\n  __typename\n}\n\nfragment StartupInsightNewsFragment on Startup {\n  id\n  newsStoryUrl\n  newsStoryHeadline\n  newsStorySnippet\n  newsStoryThumbnailUrl\n  newsStoryPublishedDate\n  newsStorySource\n  __typename\n}\n\nfragment StarStartupButtonFragment on Startup {\n  id\n  currentUserHasStarred\n  __typename\n}\n\nfragment JobListingListFragment on JobListing {\n  id\n  autoPosted\n  atsSource\n  description\n  jobType\n  liveStartAt\n  locationNames\n  primaryRoleTitle\n  remote\n  slug\n  title\n  reposted\n  ...JobListingCompensationFragment\n  __typename\n}\n\nfragment JobListingCompensationFragment on JobListingBaseInterfaceType {\n  id\n  compensation\n  estimatedSalary\n  equity\n  usesEstimatedSalary\n  __typename\n}\n\nfragment PromotedResultFragment on PromotedResult {\n  id\n  promotionId\n  promotedStartup {\n    ...StartupResultFragment\n    __typename\n  }\n  __typename\n}\n"}'`
    child = exec(command, function (error, stdout, stderr) {
      const data = JSON.parse(stdout);
      console.log(data);
      res(_.get(data, 'data.talent.jobSearchResults.startups.edges', []));

      if (error !== null) {
        console.log('exec error: ' + error);
        rej(error);
      }

    });
  });
}


module.exports = getCompanies;
