const _ = require('lodash');

function getCompanies(page) {
  return new Promise((res, rej) => {
    var exec = require('child_process').exec;

    var command = `curl 'https://angel.co/graphql?fallbackAOR=talent' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.16; rv:86.0) Gecko/20100101 Firefox/86.0' -H 'Accept: */*' -H 'Accept-Language: en-US,en;q=0.5' --compressed -H 'Referer: https://angel.co/jobs' -H 'content-type: application/json' -H 'X-Requested-With: XMLHttpRequest' -H 'X-AL-GQL: 35HTrz2IqczIFe3pHhVpHEj1nHGcFYS1U8OJsMjLaJs%3D' -H 'Origin: https://angel.co' -H 'Connection: keep-alive' -H 'Cookie: __cfduid=d4c093f180ec652672f4c60ac2317d9011615277201; datadome=Cjl8Jgo_WhT407-b0LEXHfpQH4DWWK-ldPzJeYpvptrUXEJjZuSy~W8_adytYblPlOUWV6FZ2zh17UYHCoCypN-pS.MCBnHPT_2uICPHKv; _angellist=520a7731239a26f398dd10c6914ac8a0; _ga=GA1.2.272816328.1615276803; _gid=GA1.2.1049792614.1615276803; _dd_s=rum=1&id=a97ae1bf-674d-49fe-a4c3-197c5a9d699c&created=1615276803136&expire=1615278159126; _hjid=85144c36-e888-49db-ba54-14a8a3540587; _hjFirstSeen=1; _hjIncludedInSessionSample=1; _hjAbsoluteSessionInProgress=1; g_state={"i_p":1615284029599,"i_l":1}; ajs_user_id=%2210728649%22; logged_in=true; ajs_anonymous_id=%22c228944d-e866-4202-8122-6be6ea3fbfc2%22; _mkra_stck=c4e45e3c0194a7bf9de72f8bbd30c56c%3A1615277262.8038933' -H 'TE: Trailers' --data-raw '{"operationName":"JobSearchResultsX","variables":{"filterConfigurationInput":{"page":${page},"remoteCompanyLocationTagIds":["153509"],"equity":{"min":null,"max":null},"remotePreference":"NO_REMOTE","salary":{"min":null,"max":null},"yearsExperience":{"min":null,"max":null}}},"query":"query JobSearchResultsX($filterConfigurationInput: FilterConfigurationInput!) {\n  talent {\n    jobSearchResults(filterConfigurationInput: $filterConfigurationInput) {\n      rawQuery\n      totalStartupCount\n      startups {\n        edges {\n          node {\n            ... on StartupSearchResult {\n              ...StartupResultSearchResultFragment\n              __typename\n            }\n            ... on PromotedResult {\n              ...PromotedResultFragment\n              __typename\n            }\n            ... on FeaturedStartups {\n              id\n              featuredStartups {\n                ...PromotedResultFragment\n                __typename\n              }\n              __typename\n            }\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n}\n\nfragment StartupResultSearchResultFragment on StartupSearchResult {\n  id\n  ...BadgeBarSearchResultFragment\n  ...StartupHeaderSearchResultFragment\n  ...StartupInsightNewsSearchResultFragment\n  ...StarStartupSearchResultButtonFragment\n  highlightedJobListings {\n    ...JobListingListSearchResultFragment\n    __typename\n  }\n  __typename\n}\n\nfragment BadgeBarSearchResultFragment on StartupSearchResult {\n  id\n  badges {\n    ...BadgeFragment\n    __typename\n  }\n  __typename\n}\n\nfragment BadgeFragment on Badge {\n  id\n  name\n  label\n  tooltip\n  avatarUrl\n  rating\n  __typename\n}\n\nfragment StartupHeaderSearchResultFragment on StartupSearchResult {\n  id\n  name\n  slug\n  logoUrl\n  highConcept\n  companySize\n  locationTaggings {\n    id\n    displayName\n    __typename\n  }\n  __typename\n}\n\nfragment StartupInsightNewsSearchResultFragment on StartupSearchResult {\n  id\n  newsStoryUrl\n  newsStoryHeadline\n  newsStorySnippet\n  newsStoryThumbnailUrl\n  newsStoryPublishedDate\n  newsStorySource\n  __typename\n}\n\nfragment StarStartupSearchResultButtonFragment on StartupSearchResult {\n  id\n  currentUserHasStarred\n  __typename\n}\n\nfragment JobListingListSearchResultFragment on JobListingSearchResult {\n  id\n  autoPosted\n  atsSource\n  description\n  jobType\n  liveStartAt\n  locationNames\n  primaryRoleTitle\n  remote\n  slug\n  title\n  reposted\n  ...JobListingCompensationSearchResultFragment\n  __typename\n}\n\nfragment JobListingCompensationSearchResultFragment on JobListingSearchResult {\n  id\n  compensation\n  estimatedSalary\n  equity\n  usesEstimatedSalary\n  __typename\n}\n\nfragment StartupResultFragment on Startup {\n  id\n  startupId\n  ...BadgeBarFragment\n  ...StartupHeaderFragment\n  ...StartupInsightNewsFragment\n  ...StarStartupButtonFragment\n  highlightedJobListings {\n    ...JobListingListFragment\n    __typename\n  }\n  __typename\n}\n\nfragment BadgeBarFragment on Startup {\n  id\n  badges {\n    ...BadgeFragment\n    __typename\n  }\n  __typename\n}\n\nfragment StartupHeaderFragment on Startup {\n  id\n  name\n  slug\n  logoUrl\n  highConcept\n  companySize\n  __typename\n}\n\nfragment StartupInsightNewsFragment on Startup {\n  id\n  newsStoryUrl\n  newsStoryHeadline\n  newsStorySnippet\n  newsStoryThumbnailUrl\n  newsStoryPublishedDate\n  newsStorySource\n  __typename\n}\n\nfragment StarStartupButtonFragment on Startup {\n  id\n  currentUserHasStarred\n  __typename\n}\n\nfragment JobListingListFragment on JobListing {\n  id\n  autoPosted\n  atsSource\n  description\n  jobType\n  liveStartAt\n  locationNames\n  primaryRoleTitle\n  remote\n  slug\n  title\n  reposted\n  ...JobListingCompensationFragment\n  __typename\n}\n\nfragment JobListingCompensationFragment on JobListingBaseInterfaceType {\n  id\n  compensation\n  estimatedSalary\n  equity\n  usesEstimatedSalary\n  __typename\n}\n\nfragment PromotedResultFragment on PromotedResult {\n  id\n  promotionId\n  promotedStartup {\n    ...StartupResultFragment\n    __typename\n  }\n  __typename\n}\n"}'`

    child = exec(command, function (error, stdout, stderr) {
      const data = JSON.parse(stdout);
      res(_.get(data, 'data.talent.jobSearchResults.startups.edges', []));

      if (error !== null) {
        console.log('exec error: ' + error);
        rej(error);
      }

    });
  });
}


module.exports = getCompanies;
